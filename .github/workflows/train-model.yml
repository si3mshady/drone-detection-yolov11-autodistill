name: Drone Detection Training

on:
  push:
    paths:
      - 'images/**'
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-glx \
            libglib2.0-0 \
            libsm6 \
            libxext6 \
            libxrender-dev \
            libgomp1 \
            libgdal-dev \
            ffmpeg \
            libsndfile1
      
      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip setuptools wheel
          pip install ultralytics autodistill autodistill-grounded-sam
          pip install opencv-python==4.11.0.86 opencv-contrib-python==4.11.0.86
          pip install scipy==1.15.3 scikit-image==0.25.2 scikit-learn==1.6.1
          pip install pillow==11.2.1 imageio==2.37.0
          pip install transformers==4.53.2 datasets==2.14.4
          pip install huggingface-hub==0.33.4 tokenizers==0.21.2
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install numpy==2.0.2 pandas==2.2.2 matplotlib==3.10.0
          pip install requests==2.32.3 urllib3==2.4.0
          pip install tqdm==4.67.1 packaging==25.0
          pip install wandb==0.21.0
      
      - name: Clean Dataset (Clean Slate Method)
        run: |
          echo "üßπ Clean slate - removing old dataset..."
          rm -rf dataset/
      
      - name: Count Images
        run: |
          image_count=$(find images/ -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" 2>/dev/null | wc -l)
          echo "üìä Found $image_count images to process"
          if [ $image_count -eq 0 ]; then
            echo "‚ùå No images found in images/ folder"
            exit 1
          fi
      
      - name: Autodistill Labeling and YOLO Training
        env:
          WANDB_API_KEY: "632f1185ffe5698beda8749147a1a6772de21e39"
          PYTHONUNBUFFERED: "1"
          HF_HUB_DISABLE_SYMLINKS_WARNING: "1"
        run: |
          python3 << 'EOF'
          import os
          from autodistill_grounded_sam import GroundedSAM
          from autodistill.detection import CaptionOntology
          from ultralytics import YOLO
          
          print('üîç Auto-labeling images with GroundedSAM...')
          ontology = CaptionOntology({
              'DJI Phantom drone flying in the sky': 'drone',
              'DJI Phantom drone on a surface': 'drone'
          })
          
          base = GroundedSAM(ontology=ontology)
          base.label(input_folder='./images', output_folder='dataset')
          
          # Verify dataset creation
          n_labels = len(os.listdir('dataset/train/labels'))
          n_images = len(os.listdir('dataset/train/images'))
          print(f'‚úÖ Dataset created: {n_labels} labels for {n_images} images')
          
          if n_labels == 0:
              raise RuntimeError('‚ùå No labels created')
          
          # Train YOLO model
          print('üéØ Training YOLOv11 for 50 epochs...')
          model = YOLO('yolo11n-seg.pt')
          model.train(
              data='dataset/data.yaml',
              epochs=50,
              imgsz=640,
              batch=16,
              patience=25,
              verbose=True
          )
          
          print('üéâ Training completed!')
          EOF
      
      - name: Upload Trained Model
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: drone-model-${{ github.sha }}
          path: runs/segment/train/weights/best.pt
          retention-days: 30
